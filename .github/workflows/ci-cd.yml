# CI/CD Pipeline - Legacy Jekyll (being replaced by astro-deploy.yml)
# This workflow is kept for backwards compatibility with main branch
# The new Astro site uses .github/workflows/astro-deploy.yml

name: CI/CD Pipeline (Legacy)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'astro-site/**'
      - '.github/workflows/astro-deploy.yml'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'astro-site/**'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting (non-blocking during migration)
      continue-on-error: true
      run: npm run lint || echo "⚠️ Lint warnings found (non-blocking during Astro migration)"

    - name: Basic functionality test
      run: |
        # Start a simple HTTP server for testing
        python3 -m http.server 8000 &
        SERVER_PID=$!

        # Wait for server to start
        sleep 2

        # Test basic page load
        if curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/index.html | grep -q "200"; then
          echo "✅ Website loads successfully"
        else
          echo "❌ Website failed to load"
          kill $SERVER_PID
          exit 1
        fi

        # Clean up
        kill $SERVER_PID

  deploy-production:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: lint-and-test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy notification
      run: |
        echo "## ℹ️ Legacy Jekyll Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This workflow handles the legacy Jekyll site on main branch." >> $GITHUB_STEP_SUMMARY
        echo "The new Astro site is deployed via astro-deploy.yml workflow." >> $GITHUB_STEP_SUMMARY